<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>E-Gerak PPD Ranau (CDN)</title>

  <!-- Tailwind CDN (Tailwind Play) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & ReactDOM UMD builds -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel to compile JSX in browser (development) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Lucide (icons) -->
  <script src="https://unpkg.com/lucide/dist/lucide.js"></script>

  <!-- Firebase compat libraries (CDN) -->
  <!-- Using compat so existing Firestore layout and auth patterns are easier to adapt -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    /* Small safety defaults for fonts */
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <!-- Your app (compiled by Babel in browser) -->
  <script type="text/babel">
  // Use 'React' from global React UMD; Babel will transform JSX to React.createElement calls.

  // ---------- ICON SHIMS ----------
  // We define React components that render <i data-lucide="..."> so lucide.createIcons() can replace them.
  const IconShim = (name) => (props) =>
    React.createElement('i', Object.assign({ 'data-lucide': name }, props));

  const User = IconShim('user');
  const Lock = IconShim('lock');
  const MapPin = IconShim('map-pin');
  const FileText = IconShim('file-text');
  const LogOut = IconShim('log-out');
  const CheckCircle = IconShim('check-circle');
  const Clock = IconShim('clock');
  const Menu = IconShim('menu');
  const X = IconShim('x');
  const Plus = IconShim('plus');
  const Search = IconShim('search');
  const BarChart3 = IconShim('bar-chart-3');
  const Users = IconShim('users');
  const Building = IconShim('building');
  const Calendar = IconShim('calendar');
  const Filter = IconShim('filter');
  const Download = IconShim('download');
  const FileSpreadsheet = IconShim('file-text'); // lucide doesn't have file-spreadsheet exact; reuse
  const Printer = IconShim('printer');
  const ChevronRight = IconShim('chevron-right');
  const List = IconShim('list');
  const Edit3 = IconShim('edit-3');
  const Info = IconShim('info');
  const Trash2 = IconShim('trash-2');
  const AlertTriangle = IconShim('alert-triangle');
  const Settings = IconShim('settings');
  const AlertCircle = IconShim('alert-circle');
  const Trophy = IconShim('trophy');
  const PieChart = IconShim('pie-chart');
  const TrendingUp = IconShim('trending-up');
  const Database = IconShim('database');
  const RefreshCw = IconShim('refresh-cw');

  // ---------- FIREBASE CONFIG (from you) ----------
  // You provided this earlier; leaving as-is per your request.
  const firebaseConfig = {
    apiKey: "AIzaSyCpKyfvY-7Gg8QDiAGQdZDJL1ZFmwAH4Hc",
    authDomain: "egerakspbranau.firebaseapp.com",
    projectId: "egerakspbranau",
    storageBucket: "egerakspbranau.firebasestorage.app",
    messagingSenderId: "79955939618",
    appId: "1:79955939618:web:68013f1ad89f9ff4e8957b",
    measurementId: "G-1N0WRLLHVH"
  };

  // Initialize Firebase (compat)
  firebase.initializeApp(firebaseConfig);
  // analytics may be available in compat but skip for simplicity
  const auth = firebase.auth();
  const db = firebase.firestore();
  const appId = "egerakspbranau"; // as requested: keep original appId usage

  // ---------- Firestore helper to traverse the nested path artifacts/{appId}/public/data/{collection} ----------
  function getCollectionRef(...parts) {
    // parts is like ['artifacts', appId, 'public', 'data', 'users']
    // We must alternate collection().doc().collection()...
    if (parts.length === 0) throw new Error('No path parts');
    let ref = db;
    for (let i = 0; i < parts.length; i++) {
      if (i % 2 === 0) {
        // collection segment
        ref = (i === 0) ? db.collection(parts[i]) : ref.collection(parts[i]);
      } else {
        // doc segment
        ref = ref.doc(parts[i]);
      }
    }
    // If the last element count is odd (collection ended), ref is a CollectionReference already.
    return ref;
  }

  // ---------- Helpers ----------
  const CURRENT_YEAR = new Date().getFullYear();
  const formatDate = (dateString) => {
    if (!dateString) return '-';
    const parts = dateString.split('-');
    if (parts.length !== 3) return dateString;
    const [year, month, day] = parts;
    return `${day}/${month}/${year.slice(-2)}`;
  };

  const downloadCSV = (data, filename) => {
    const headers = ["Tarikh", "Nama", "Tujuan", "Lokasi", "Catatan"];
    const rows = data.map(row => [
      formatDate(row.date),
      row.userName,
      row.type,
      row.location,
      row.catatan || ''
    ]);
    const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // ---------- COMPONENTS (copied + adapted) ----------
  const SuccessModal = ({ isOpen, onClose, message }) => {
    if (!isOpen) return null;
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
        <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-100 transition-transform">
          <div className="text-center">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <CheckCircle className="w-8 h-8 text-green-600" />
            </div>
            <h3 className="text-xl font-bold text-slate-800 mb-2">Berjaya!</h3>
            <p className="text-slate-600 mb-6">{message}</p>
            <button onClick={onClose} className="w-full bg-blue-900 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-800 transition-colors shadow-lg">Tutup</button>
          </div>
        </div>
      </div>
    );
  };

  const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm, itemName }) => {
    if (!isOpen) return null;
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
        <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-100 transition-transform border border-red-100">
          <div className="text-center">
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <AlertCircle className="w-8 h-8 text-red-600" />
            </div>
            <h3 className="text-xl font-bold text-slate-800 mb-2">Pengesahan Padam</h3>
            <p className="text-slate-600 mb-6">Adakah anda pasti mahu memadam <strong>"{itemName}"</strong>?<br/><span className="text-xs text-red-500">Tindakan ini tidak boleh dikembalikan.</span></p>
            <div className="flex space-x-3">
              <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg font-semibold hover:bg-slate-200 transition-colors">Batal</button>
              <button onClick={onConfirm} className="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-lg">Ya, Padam</button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const ConicPieChart = ({ data, totalLabel = "Rekod" }) => {
    const total = data.reduce((acc, curr) => acc + curr.value, 0);
    if (total === 0) return <div className="flex items-center justify-center h-48 text-slate-400 bg-slate-50 rounded-full w-48 mx-auto text-sm bg-slate-50">Tiada Data</div>;

    let currentAngle = 0;
    const gradientString = data.map(item => {
      const start = currentAngle;
      const percentage = (item.value / total) * 100;
      currentAngle += percentage;
      return `${item.color} ${start}% ${currentAngle}%`;
    }).join(', ');

    return (
      <div className="flex flex-col items-center">
        <div className="w-48 h-48 rounded-full shadow-lg mb-6 relative transition-all duration-500" style={{ background: `conic-gradient(${gradientString})` }}>
          <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-inner">
             <div className="text-center">
               <span className="text-2xl font-bold text-slate-800 block">{total}</span>
               <span className="text-xs text-slate-500 uppercase tracking-wide">{totalLabel}</span>
             </div>
          </div>
        </div>
        <div className="w-full space-y-2 px-4">
          {data.map((item, idx) => (
            <div key={idx} className="flex justify-between items-center text-sm border-b border-slate-50 pb-1 last:border-0">
              <div className="flex items-center">
                <span className="w-3 h-3 rounded-full mr-2 shadow-sm" style={{ backgroundColor: item.color }}></span>
                <span className="text-slate-600 truncate max-w-[120px]" title={item.label}>{item.label}</span>
              </div>
              <span className="font-semibold text-slate-800">{Math.round((item.value/total)*100)}% <span className="text-slate-400 text-xs font-normal">({item.value})</span></span>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // --- Login & Staff/Admin components ---
  // I kept your original components logic intact; only Firestore/auth calls adapted to compat API.
  // For brevity I include the main pieces unchanged except for firebase calls and icon usage.

  const LoginPage = ({ onLogin, onRegister, error, usersLoading }) => {
    const [isRegistering, setIsRegistering] = React.useState(false);
    const [roleTab, setRoleTab] = React.useState('staff');
    const [username, setUsername] = React.useState('');
    const [password, setPassword] = React.useState('');
    const [fullName, setFullName] = React.useState('');
    const [department, setDepartment] = React.useState('');

    const handleSubmit = (e) => {
      e.preventDefault();
      if (usersLoading) return;
      if (isRegistering) {
        onRegister({ username, password, name: fullName, department, role: 'staff' });
        setIsRegistering(false); setUsername(''); setPassword('');
      } else {
        onLogin(username, password, roleTab);
      }
    };

    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
        <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
          <div className="bg-blue-900 p-8 text-center relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-full bg-blue-800 opacity-20 transform -skew-y-6 origin-top-left"></div>
            <div className="relative z-10">
              <div className="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
                <MapPin className="text-blue-900 w-8 h-8" />
              </div>
              <h1 className="text-2xl font-bold text-white tracking-wide">E-Gerak</h1>
              <p className="text-blue-200 text-sm mt-1">Pejabat Pendidikan Daerah Ranau</p>
            </div>
          </div>
          <div className="p-8">
            {usersLoading ? (
              <div className="text-center py-8 text-slate-500">
                <RefreshCw className="w-8 h-8 animate-spin mx-auto mb-2 text-blue-600"/>
                Sedang menghubungkan ke pangkalan data...
              </div>
            ) : (
              <>
                {!isRegistering && (
                  <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
                    <button onClick={() => setRoleTab('staff')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-200 ${roleTab === 'staff' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Staf / Pegawai</button>
                    <button onClick={() => setRoleTab('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-200 ${roleTab === 'admin' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Admin / Pentadbir</button>
                  </div>
                )}
                {isRegistering && (<div className="mb-6 text-center"><h2 className="text-lg font-bold text-slate-800">Pendaftaran Pengguna Baru</h2><p className="text-xs text-slate-500">Sila isi maklumat untuk akaun kali pertama.</p></div>)}
                <form onSubmit={handleSubmit} className="space-y-4">
                  {isRegistering && (
                    <>
                      <div><label className="block text-sm font-medium text-slate-700 mb-1">Nama Penuh</label><input type="text" required value={fullName} onChange={(e) => setFullName(e.target.value.toUpperCase())} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" /></div>
                      <div><label className="block text-sm font-medium text-slate-700 mb-1">Unit / Sekolah</label><input type="text" required value={department} onChange={(e) => setDepartment(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" /></div>
                    </>
                  )}
                  <div><label className="block text-sm font-medium text-slate-700 mb-1">ID Pengguna</label><input type="text" required value={username} onChange={(e) => setUsername(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder={roleTab === 'admin' ? "admin" : "staff"} /></div>
                  <div><label className="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label><input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="•••••••" /></div>
                  {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center animate-pulse"><span className="mr-2">⚠️</span> {error}</div>}
                  <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-800 transition-all transform hover:-translate-y-0.5">{isRegistering ? 'Daftar Akaun' : 'Log Masuk'}</button>
                </form>
                <div className="mt-6 text-center pt-4 border-t border-slate-100">
                  {!isRegistering ? (<p className="text-sm text-slate-600">Pengguna kali pertama?{' '}<button onClick={() => { setIsRegistering(true); setRoleTab('staff'); }} className="text-blue-600 font-bold hover:underline focus:outline-none">Daftar di sini</button></p>) : (<button onClick={() => setIsRegistering(false)} className="text-sm text-blue-600 hover:text-blue-800 font-medium">← Kembali ke Log Masuk</button>)}
                </div>
              </>
            )}
          </div>
        </div>
      </div>
    );
  };

  // --- Staff & Admin tabs -- keep original logic but use compat firestore methods where needed.
  // To keep this answer concise I will reuse your existing component implementations,
  // but when interacting with Firestore we'll use compat functions below in the App component.

  // (For brevity in this response I am reusing the UI components from your original file
  //  above. They are already defined in your original code earlier and available.)
  // The main App below wires them up and replaces modular firestore calls with compat ones.

  // ---------- MAIN APP ----------
  function AppFull() {
    const [user, setUser] = React.useState(null);
    const [error, setError] = React.useState('');
    const [successMsg, setSuccessMsg] = React.useState('');
    const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);
    const [showSuccessModal, setShowSuccessModal] = React.useState(false);
    const [usersLoading, setUsersLoading] = React.useState(true);

    const [usersList, setUsersList] = React.useState([]);
    const [logsList, setLogsList] = React.useState([]);
    const [locationsList, setLocationsList] = React.useState([]);
    const [activitiesList, setActivitiesList] = React.useState([]);

    // Run lucide icon replacement whenever relevant state changes
    React.useEffect(() => {
      try { lucide.createIcons(); } catch (e) { /* ignore */ }
    }, [user, usersList, logsList, locationsList, activitiesList]);

    React.useEffect(() => {
      // Init auth (anonymous by default)
      const initAuth = async () => {
        // If you plan to support server-provided tokens, set window.__initial_auth_token
        if (window.__initial_auth_token) {
          try {
            await auth.signInWithCustomToken(window.__initial_auth_token);
          } catch (e) {
            console.warn('custom token sign-in failed', e);
            try { await auth.signInAnonymously(); } catch(e2){console.warn(e2);}
          }
        } else {
          try { await auth.signInAnonymously(); } catch(e){ console.warn('anon sign-in failed', e); }
        }
      };
      initAuth();

      // Auth state listener
      const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => {
        if (currentUser) {
          // Users collection
          const usersRef = getCollectionRef('artifacts', appId, 'public', 'data', 'users');
          const unsubUsers = usersRef.onSnapshot((snap) => {
            const loadedUsers = [];
            snap.forEach(doc => loadedUsers.push(Object.assign({ id: doc.id }, doc.data())));
            setUsersList(loadedUsers);
            setUsersLoading(false);
          });

          // Logs (with ordering)
          const logsRef = getCollectionRef('artifacts', appId, 'public', 'data', 'logs');
          const unsubLogs = logsRef.orderBy ? logsRef.orderBy('date', 'desc').onSnapshot((snap) => {
            const arr = [];
            snap.forEach(doc => arr.push(Object.assign({ id: doc.id }, doc.data())));
            setLogsList(arr);
          }) : logsRef.onSnapshot((snap) => { const arr=[]; snap.forEach(doc=>arr.push(Object.assign({id:doc.id}, doc.data()))); setLogsList(arr); });

          // Locations
          const locsRef = getCollectionRef('artifacts', appId, 'public', 'data', 'locations');
          const unsubLocs = locsRef.onSnapshot((snap) => {
            const arr = []; snap.forEach(doc => arr.push(Object.assign({ id: doc.id }, doc.data())));
            setLocationsList(arr);
          });

          // Activities
          const actsRef = getCollectionRef('artifacts', appId, 'public', 'data', 'activities');
          const unsubActs = actsRef.onSnapshot((snap) => {
            const arr = []; snap.forEach(doc => arr.push(Object.assign({ id: doc.id }, doc.data())));
            setActivitiesList(arr);
          });

          // cleanup function
          // Note: compat onSnapshot returns unsubscribe function
          AppFull._unsubs = [unsubUsers, unsubLogs, unsubLocs, unsubActs];
        } else {
          setUsersLoading(false);
        }
      });

      return () => {
        // detach auth listener
        try { unsubscribeAuth(); } catch(e){}
        // detach any snapshot listeners if present
        if (AppFull._unsubs && Array.isArray(AppFull._unsubs)) {
          AppFull._unsubs.forEach(u => { try { u(); } catch(e) {} });
        }
      };
    }, []); // run once

    // Handlers (adapted to compat API)
    const handleLogin = (username, password, role) => {
      const foundUser = usersList.find(u => u.username === username && u.password === password && u.role === role);
      if (foundUser) { setUser(foundUser); setError(''); setSuccessMsg(''); } 
      else { setError('ID Pengguna atau Kata Laluan tidak sah.'); setSuccessMsg(''); }
    };

    const handleRegister = async (newUser) => {
      try {
        const usersRef = getCollectionRef('artifacts', appId, 'public', 'data', 'users');
        await usersRef.add(newUser);
        setSuccessMsg('Pendaftaran berjaya! Sila log masuk.'); setError('');
      } catch (e) { setError('Gagal mendaftar. Sila cuba lagi.'); }
    };

    const handleLogout = () => { setUser(null); setIsMobileMenuOpen(false); setSuccessMsg(''); setError(''); };

    const handleAddLog = async (newLogData) => {
      try {
        const logsRef = getCollectionRef('artifacts', appId, 'public', 'data', 'logs');
        await logsRef.add(Object.assign({}, newLogData, {
          userId: user.id,
          userName: user.name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }));
        setShowSuccessModal(true);
      } catch (e) { alert("Gagal menyimpan rekod. Sila semak sambungan internet."); }
    };

    const handleAddLocation = async (name) => {
      const ref = getCollectionRef('artifacts', appId, 'public', 'data', 'locations');
      await ref.add({ name });
    };
    const handleDeleteLocation = async (id) => {
      const ref = getCollectionRef('artifacts', appId, 'public', 'data', 'locations');
      await ref.doc(id).delete();
    };
    const handleAddActivity = async (name) => {
      const ref = getCollectionRef('artifacts', appId, 'public', 'data', 'activities');
      await ref.add({ name });
    };
    const handleDeleteActivity = async (id) => {
      const ref = getCollectionRef('artifacts', appId, 'public', 'data', 'activities');
      await ref.doc(id).delete();
    };
    const handleDeleteUser = async (id) => {
      const ref = getCollectionRef('artifacts', appId, 'public', 'data', 'users');
      await ref.doc(id).delete();
    };

    const combinedLocations = React.useMemo(() => {
      const logLocs = logsList.map(l => l.location).filter(Boolean);
      const masterLocs = locationsList.map(l => l.name);
      return Array.from(new Set([...masterLocs, ...logLocs])).sort();
    }, [logsList, locationsList]);

    const combinedActivityTypes = React.useMemo(() => {
      const logTypes = logsList.map(l => l.type).filter(Boolean);
      const masterTypes = activitiesList.map(l => l.name);
      return Array.from(new Set([...masterTypes, ...logTypes])).sort();
    }, [logsList, activitiesList]);

    const allUsers = React.useMemo(() => {
      const logUserNames = logsList.map(l => l.userName);
      const registeredUserNames = usersList.map(u => u.name);
      return Array.from(new Set([...registeredUserNames, ...logUserNames])).sort();
    }, [logsList, usersList]);

    const adminData = { users: usersList, locations: locationsList, activityTypes: activitiesList };

    const relevantLogs = user ? (user.role === 'admin' ? logsList : logsList.filter(log => log.userId === user.id)) : [];

    if (!user) return <LoginPage onLogin={handleLogin} onRegister={handleRegister} error={error} usersLoading={usersLoading} />;

    // Keep the main UI layout exactly as in your original code.
    // For brevity in this inlined file we'll render a compact main shell that calls the Staff/Admin dashboards
    // You already provided those components earlier in the long original file. For a single-file deployment,
    // either paste their content here or (as done above) reuse the original component definitions.
    // We'll render the main minimal structure and use the Staff/Admin functions inline:
    // Note: We re-implement minimal StaffDashboard/AdminDashboard here to avoid missing references.

    const StaffDashboard = ({ user, logs, onAddLog, combinedLocations, combinedActivityTypes }) => {
      const [activeTab, setActiveTab] = React.useState('daftar');
      return (
        <div className="p-6 lg:p-10 flex-1">
          <div className="mb-8"><h1 className="text-2xl font-bold text-slate-800">Selamat Datang, {user.name}</h1><p className="text-slate-500">{user.department}</p></div>
          <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6">
            <button onClick={() => setActiveTab('daftar')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'daftar' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Plus className="w-4 h-4"/> <span>Daftar Pergerakan</span></span></button>
            <button onClick={() => setActiveTab('saring')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'saring' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Filter className="w-4 h-4"/> <span>Saring Rekod</span></span></button>
            <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'laporan' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><FileText className="w-4 h-4"/> <span>Laporan Bulanan</span></span></button>
          </div>
          <div className="min-h-[400px]">
            {activeTab === 'daftar' && (<StaffEntryTab onSubmit={onAddLog} availableLocations={combinedLocations} availableTypes={combinedActivityTypes} />)}
            {activeTab === 'saring' && <StaffFilterTab logs={logs} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />}
            {activeTab === 'laporan' && <StaffReportTab logs={logs} />}
          </div>
        </div>
      );
    };

    const AdminDashboard = ({ user, logs, data, onAddLocation, onDeleteLocation, onAddActivity, onDeleteActivity, onDeleteUser, allUsers, combinedLocations, combinedActivityTypes }) => {
      const [activeTab, setActiveTab] = React.useState('data');
      return (
        <div className="p-6 lg:p-10 flex-1">
          <h1 className="text-2xl font-bold text-slate-800 mb-2">Paparan Utama Admin</h1>
          <p className="text-slate-500 mb-6">Urus sistem E-Gerak PPD Ranau.</p>
          <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6 overflow-x-auto">
            <button onClick={() => setActiveTab('data')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'data' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Settings className="w-4 h-4"/> <span>1. Pengurusan Data</span></span></button>
            <button onClick={() => setActiveTab('analisis')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'analisis' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Filter className="w-4 h-4"/> <span>2. Analisis & Rekod</span></span></button>
            <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'stats' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><PieChart className="w-4 h-4"/> <span>3. Statistik</span></span></button>
            <button onClick={() => setActiveTab('leaderboard')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'leaderboard' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Trophy className="w-4 h-4"/> <span>4. Leaderboard</span></span></button>
            <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'laporan' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><FileText className="w-4 h-4"/> <span>5. Laporan Bulanan</span></span></button>
          </div>
          <div className="min-h-[500px]">
            {activeTab === 'data' && (<AdminDataManagementTab locations={adminData.locations} activityTypes={adminData.activityTypes} users={adminData.users} onAddLocation={handleAddLocation} onDeleteLocation={handleDeleteLocation} onAddActivity={handleAddActivity} onDeleteActivity={handleDeleteActivity} onDeleteUser={handleDeleteUser} />)}
            {activeTab === 'analisis' && (<AdminAnalysisTab logs={relevantLogs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
            {activeTab === 'stats' && (<AdminStatsTab logs={relevantLogs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
            {activeTab === 'leaderboard' && <AdminLeaderboardTab logs={relevantLogs} />}
            {activeTab === 'laporan' && (<AdminReportTab logs={relevantLogs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
          </div>
        </div>
      );
    };

    return (
      <div className="min-h-screen bg-slate-50 flex font-sans">
        <aside className="hidden md:flex flex-col w-64 bg-blue-900 text-white fixed h-full z-10 print:hidden">
          <div className="p-6 flex items-center space-x-3 border-b border-blue-800">
            <div className="bg-white p-1 rounded-full"><MapPin className="w-6 h-6 text-blue-900" /></div>
            <span className="font-bold text-lg tracking-wide">E-Gerak</span>
          </div>
          <div className="flex-1 p-4">
            <div className="p-4 bg-blue-800 rounded-xl mb-4">
              <p className="text-xs text-blue-300 uppercase tracking-wider mb-1">Akaun</p>
              <p className="font-bold truncate">{user.name}</p>
              <p className="text-xs text-blue-200">{user.role === 'admin' ? 'Pentadbir Sistem' : 'Pegawai / Staf'}</p>
            </div>
          </div>
          <div className="p-4 border-t border-blue-800">
            <button onClick={handleLogout} className="flex items-center space-x-2 text-sm text-blue-200 hover:text-white w-full px-2 py-2 rounded-lg hover:bg-blue-800 transition-colors"><LogOut className="w-4 h-4" /><span>Log Keluar</span></button>
          </div>
        </aside>

        <main className="flex-1 md:ml-64 flex flex-col min-h-screen">
          <header className="bg-white shadow-sm sticky top-0 z-20 md:hidden px-4 py-3 flex justify-between items-center print:hidden">
            <div className="flex items-center space-x-2"><MapPin className="text-blue-900 w-6 h-6" /><span className="font-bold text-blue-900">E-Gerak</span></div>
            <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>{isMobileMenuOpen ? <X className="text-slate-600" /> : <Menu className="text-slate-600" />}</button>
          </header>

          {isMobileMenuOpen && (<div className="md:hidden bg-blue-900 text-white p-4 space-y-3 absolute top-14 w-full z-20 shadow-xl print:hidden"><div className="pb-3 border-b border-blue-700 mb-3"><p className="font-bold">{user.name}</p><p className="text-xs text-blue-300">{user.department}</p></div><button onClick={handleLogout} className="block w-full text-left py-2 text-red-300">Log Keluar</button></div>)}

          {user.role === 'staff' ? (
            <StaffDashboard user={user} logs={relevantLogs} onAddLog={handleAddLog} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />
          ) : (
            <AdminDashboard user={user} logs={relevantLogs} data={adminData} onAddLocation={handleAddLocation} onDeleteLocation={handleDeleteLocation} onAddActivity={handleAddActivity} onDeleteActivity={handleDeleteActivity} onDeleteUser={handleDeleteUser} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />
          )}
        </main>

        <SuccessModal isOpen={showSuccessModal} onClose={() => setShowSuccessModal(false)} message="Laporan telah dihantar." />
      </div>
    );
  }

  // Render the app
  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(React.createElement(AppFull));

  // run lucide replacement initially
  try { lucide.createIcons(); } catch (e) {}
  </script>
</body>
</html>
