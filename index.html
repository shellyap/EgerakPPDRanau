import React, { useState, useEffect, useMemo } from 'react';
import { 
  User, Lock, MapPin, FileText, LogOut, CheckCircle, Clock, 
  Menu, X, Plus, Search, BarChart3, Users, Building, 
  Calendar, Filter, Download, FileSpreadsheet, Printer, ChevronRight, 
  List, Edit3, Info, Trash2, AlertTriangle, Settings, AlertCircle, 
  Trophy, PieChart, TrendingUp, Database, RefreshCw
} from 'lucide-react';

// --- FIREBASE IMPORTS ---
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  deleteDoc, 
  doc, 
  onSnapshot, 
  query, 
  orderBy,
  serverTimestamp 
} from 'firebase/firestore';

// --- FIREBASE SETUP ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- HELPER: DYNAMIC DATE ---
const CURRENT_YEAR = new Date().getFullYear();

// --- HELPER: FORMAT DATE (YYYY-MM-DD to DD/MM/YY) ---
const formatDate = (dateString) => {
  if (!dateString) return '-';
  const parts = dateString.split('-');
  if (parts.length !== 3) return dateString;
  const [year, month, day] = parts;
  return `${day}/${month}/${year.slice(-2)}`;
};

// --- HELPER: CSV DOWNLOAD ---
const downloadCSV = (data, filename) => {
  const headers = ["Tarikh", "Nama", "Tujuan", "Lokasi", "Catatan"];
  const rows = data.map(row => [
    formatDate(row.date),
    row.userName, 
    row.type, 
    row.location, 
    row.catatan || ''
  ]);
  
  const csvContent = "data:text/csv;charset=utf-8," 
    + [headers.join(","), ...rows.map(e => e.join(","))].join("\n");
    
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", filename);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// --- COMPONENTS ---

const SuccessModal = ({ isOpen, onClose, message }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-100 transition-transform">
        <div className="text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <CheckCircle className="w-8 h-8 text-green-600" />
          </div>
          <h3 className="text-xl font-bold text-slate-800 mb-2">Berjaya!</h3>
          <p className="text-slate-600 mb-6">{message}</p>
          <button onClick={onClose} className="w-full bg-blue-900 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-800 transition-colors shadow-lg">Tutup</button>
        </div>
      </div>
    </div>
  );
};

const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm, itemName }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-xl max-w-sm w-full p-6 shadow-2xl transform scale-100 transition-transform border border-red-100">
        <div className="text-center">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <AlertCircle className="w-8 h-8 text-red-600" />
          </div>
          <h3 className="text-xl font-bold text-slate-800 mb-2">Pengesahan Padam</h3>
          <p className="text-slate-600 mb-6">Adakah anda pasti mahu memadam <strong>"{itemName}"</strong>?<br/><span className="text-xs text-red-500">Tindakan ini tidak boleh dikembalikan.</span></p>
          <div className="flex space-x-3">
            <button onClick={onClose} className="flex-1 bg-slate-100 text-slate-700 py-2.5 rounded-lg font-semibold hover:bg-slate-200 transition-colors">Batal</button>
            <button onClick={onConfirm} className="flex-1 bg-red-600 text-white py-2.5 rounded-lg font-semibold hover:bg-red-700 transition-colors shadow-lg">Ya, Padam</button>
          </div>
        </div>
      </div>
    </div>
  );
};

const ConicPieChart = ({ data, totalLabel = "Rekod" }) => {
  const total = data.reduce((acc, curr) => acc + curr.value, 0);
  if (total === 0) return <div className="flex items-center justify-center h-48 text-slate-400 bg-slate-50 rounded-full w-48 mx-auto text-sm bg-slate-50">Tiada Data</div>;

  let currentAngle = 0;
  const gradientString = data.map(item => {
    const start = currentAngle;
    const percentage = (item.value / total) * 100;
    currentAngle += percentage;
    return `${item.color} ${start}% ${currentAngle}%`;
  }).join(', ');

  return (
    <div className="flex flex-col items-center">
      <div className="w-48 h-48 rounded-full shadow-lg mb-6 relative transition-all duration-500" style={{ background: `conic-gradient(${gradientString})` }}>
        <div className="absolute inset-0 m-auto w-32 h-32 bg-white rounded-full flex items-center justify-center shadow-inner">
           <div className="text-center">
             <span className="text-2xl font-bold text-slate-800 block">{total}</span>
             <span className="text-xs text-slate-500 uppercase tracking-wide">{totalLabel}</span>
           </div>
        </div>
      </div>
      <div className="w-full space-y-2 px-4">
        {data.map((item, idx) => (
          <div key={idx} className="flex justify-between items-center text-sm border-b border-slate-50 pb-1 last:border-0">
            <div className="flex items-center">
              <span className="w-3 h-3 rounded-full mr-2 shadow-sm" style={{ backgroundColor: item.color }}></span>
              <span className="text-slate-600 truncate max-w-[120px]" title={item.label}>{item.label}</span>
            </div>
            <span className="font-semibold text-slate-800">{Math.round((item.value/total)*100)}% <span className="text-slate-400 text-xs font-normal">({item.value})</span></span>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- LOGIN COMPONENT ---
const LoginPage = ({ onLogin, onRegister, error, usersLoading }) => {
  const [isRegistering, setIsRegistering] = useState(false);
  const [roleTab, setRoleTab] = useState('staff');
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [fullName, setFullName] = useState('');
  const [department, setDepartment] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (usersLoading) return; // Prevent submit while loading
    if (isRegistering) {
      onRegister({ username, password, name: fullName, department, role: 'staff' });
      setIsRegistering(false); setUsername(''); setPassword('');
    } else {
      onLogin(username, password, roleTab);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
        <div className="bg-blue-900 p-8 text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-full bg-blue-800 opacity-20 transform -skew-y-6 origin-top-left"></div>
          <div className="relative z-10">
            <div className="w-16 h-16 bg-white rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
              <MapPin className="text-blue-900 w-8 h-8" />
            </div>
            <h1 className="text-2xl font-bold text-white tracking-wide">E-Gerak</h1>
            <p className="text-blue-200 text-sm mt-1">Pejabat Pendidikan Daerah Ranau</p>
          </div>
        </div>
        <div className="p-8">
          {usersLoading ? (
            <div className="text-center py-8 text-slate-500">
              <RefreshCw className="w-8 h-8 animate-spin mx-auto mb-2 text-blue-600"/>
              Sedang menghubungkan ke pangkalan data...
            </div>
          ) : (
            <>
              {!isRegistering && (
                <div className="flex bg-slate-100 rounded-lg p-1 mb-6">
                  <button onClick={() => setRoleTab('staff')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-200 ${roleTab === 'staff' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Staf / Pegawai</button>
                  <button onClick={() => setRoleTab('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all duration-200 ${roleTab === 'admin' ? 'bg-white text-blue-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Admin / Pentadbir</button>
                </div>
              )}
              {isRegistering && (<div className="mb-6 text-center"><h2 className="text-lg font-bold text-slate-800">Pendaftaran Pengguna Baru</h2><p className="text-xs text-slate-500">Sila isi maklumat untuk akaun kali pertama.</p></div>)}
              <form onSubmit={handleSubmit} className="space-y-4">
                {isRegistering && (
                  <>
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Nama Penuh</label><input type="text" required value={fullName} onChange={(e) => setFullName(e.target.value.toUpperCase())} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" /></div>
                    <div><label className="block text-sm font-medium text-slate-700 mb-1">Unit / Sekolah</label><input type="text" required value={department} onChange={(e) => setDepartment(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" /></div>
                  </>
                )}
                <div><label className="block text-sm font-medium text-slate-700 mb-1">ID Pengguna</label><input type="text" required value={username} onChange={(e) => setUsername(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder={roleTab === 'admin' ? "admin" : "staff"} /></div>
                <div><label className="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label><input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="block w-full px-3 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
                {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center animate-pulse"><span className="mr-2">‚ö†Ô∏è</span> {error}</div>}
                <button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-blue-800 transition-all transform hover:-translate-y-0.5">{isRegistering ? 'Daftar Akaun' : 'Log Masuk'}</button>
              </form>
              <div className="mt-6 text-center pt-4 border-t border-slate-100">
                {!isRegistering ? (<p className="text-sm text-slate-600">Pengguna kali pertama?{' '}<button onClick={() => { setIsRegistering(true); setRoleTab('staff'); }} className="text-blue-600 font-bold hover:underline focus:outline-none">Daftar di sini</button></p>) : (<button onClick={() => setIsRegistering(false)} className="text-sm text-blue-600 hover:text-blue-800 font-medium">‚Üê Kembali ke Log Masuk</button>)}
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
};

// ... StaffEntryTab, StaffFilterTab, StaffReportTab ...
// Keeping these as per previous iteration but ensuring they receive correct props.

const StaffEntryTab = ({ onSubmit, availableLocations, availableTypes }) => {
  const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], location: '', type: '', catatan: '' });
  const [useCustomLocation, setUseCustomLocation] = useState(false);
  const [useCustomType, setUseCustomType] = useState(false);
  const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

  return (
    <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-slate-100 p-6 md:p-8">
      <div className="flex items-center space-x-3 mb-6"><div className="bg-blue-100 p-2 rounded-lg"><Plus className="w-6 h-6 text-blue-700" /></div><div><h2 className="text-xl font-bold text-slate-800">Daftar Pergerakan Harian</h2><p className="text-slate-500 text-sm">Sila isi maklumat pergerakan anda.</p></div></div>
      <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); setFormData({...formData, catatan: '', location: '', type: ''}); }} className="space-y-6">
        <div><label className="block text-sm font-medium text-slate-700 mb-2">Tarikh Pergerakan</label><input type="date" name="date" required value={formData.date} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
        <div><label className="block text-sm font-medium text-slate-700 mb-2">Lokasi / Tempat</label><div className="flex gap-2"><div className="relative w-full">{useCustomLocation ? (<input type="text" name="location" required value={formData.location} onChange={handleChange} placeholder="Sila taip lokasi baru..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" />) : (<select name="location" required value={formData.location} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg appearance-none bg-white" ><option value="">Pilih Lokasi...</option>{availableLocations.map((loc, idx) => (<option key={idx} value={loc}>{loc}</option>))}</select>)}</div><button type="button" onClick={() => { setUseCustomLocation(!useCustomLocation); setFormData({...formData, location: ''}); }} className="px-3 bg-slate-100 rounded-lg border">{useCustomLocation ? <List/> : <Plus/>}</button></div></div>
        <div><label className="block text-sm font-medium text-slate-700 mb-2">Perkara / Tujuan</label><div className="flex gap-2"><div className="relative w-full">{useCustomType ? (<input type="text" name="type" required value={formData.type} onChange={handleChange} placeholder="Sila taip tujuan baru..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" />) : (<select name="type" required value={formData.type} onChange={handleChange} className="w-full px-4 py-2.5 border border-slate-300 rounded-lg appearance-none bg-white" ><option value="">Pilih Tujuan...</option>{availableTypes.map((type, idx) => (<option key={idx} value={type}>{type}</option>))}</select>)}</div><button type="button" onClick={() => { setUseCustomType(!useCustomType); setFormData({...formData, type: ''}); }} className="px-3 bg-slate-100 rounded-lg border">{useCustomType ? <List/> : <Plus/>}</button></div></div>
        <div><label className="block text-sm font-medium text-slate-700 mb-2">Catatan</label><textarea name="catatan" rows="3" value={formData.catatan} onChange={handleChange} placeholder="Catatan tambahan..." className="w-full px-4 py-2.5 border border-slate-300 rounded-lg" ></textarea></div>
        <div className="pt-4 border-t border-slate-100"><button type="submit" className="w-full bg-blue-900 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-800 flex justify-center items-center space-x-2"><CheckCircle className="w-5 h-5" /><span>Hantar Rekod</span></button></div>
      </form>
    </div>
  );
};

const StaffFilterTab = ({ logs, combinedLocations, combinedActivityTypes }) => {
  const [filterDate, setFilterDate] = useState('');
  const [filterPlace, setFilterPlace] = useState('');
  const [filterType, setFilterType] = useState('');
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const isFilterActive = filterDate || filterPlace || filterType;
  const filteredLogs = logs.filter(log => {
    if (!isFilterActive) return log.date.startsWith(currentMonth);
    return (filterDate ? log.date === filterDate : true) && (filterPlace ? log.location === filterPlace : true) && (filterType ? log.type === filterType : true);
  });

  return (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring & Cari Rekod</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <input type="date" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm" />
          <select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm"><option value="">Semua Lokasi</option>{combinedLocations.map(l => <option key={l} value={l}>{l}</option>)}</select>
          <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm"><option value="">Semua Perkara</option>{combinedActivityTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
        </div>
        <div className="mt-4 flex justify-end"><button onClick={() => { setFilterDate(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-red-500 hover:text-red-700 underline">Kosongkan Saringan</button></div>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
        {!isFilterActive && (<div className="bg-blue-50 px-6 py-2 text-xs text-blue-700 border-b border-blue-100 flex items-center"><Info className="w-4 h-4 mr-2"/><span>Memaparkan rekod bulan semasa ({currentMonth}).</span></div>)}
        <div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="text-xs text-slate-500 uppercase bg-slate-50"><tr><th className="px-6 py-3">Tarikh</th><th className="px-6 py-3">Lokasi</th><th className="px-6 py-3">Tujuan</th><th className="px-6 py-3">Catatan</th></tr></thead><tbody>{filteredLogs.length > 0 ? filteredLogs.map((log) => (<tr key={log.id} className="border-b hover:bg-slate-50"><td className="px-6 py-4 font-medium">{formatDate(log.date)}</td><td className="px-6 py-4">{log.location}</td><td className="px-6 py-4">{log.type}</td><td className="px-6 py-4 italic text-slate-500">{log.catatan || '-'}</td></tr>)) : (<tr><td colSpan="4" className="px-6 py-8 text-center text-slate-400">Tiada rekod ditemui.</td></tr>)}</tbody></table></div>
      </div>
    </div>
  );
};

const StaffReportTab = ({ logs }) => {
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
  const monthlyLogs = logs.filter(log => log.date.startsWith(selectedMonth));
  return (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
        <div><h3 className="text-lg font-bold text-slate-800">Laporan Bulanan</h3><p className="text-slate-500 text-sm">Pilih bulan untuk melihat dan memuat turun rekod.</p></div>
        <div className="flex items-center space-x-2"><Calendar className="w-5 h-5 text-slate-400" /><input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500" /></div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button onClick={() => downloadCSV(monthlyLogs, `Log_Pergerakan_${selectedMonth}.csv`)} className="flex items-center justify-center space-x-2 bg-green-600 text-white p-4 rounded-xl shadow-sm hover:bg-green-700 transition-colors"><FileSpreadsheet className="w-6 h-6" /><div className="text-left"><div className="font-bold">Muat Turun Excel (CSV)</div><div className="text-xs text-green-100">Format hamparan standard</div></div></button>
        <button onClick={() => window.print()} className="flex items-center justify-center space-x-2 bg-slate-700 text-white p-4 rounded-xl shadow-sm hover:bg-slate-800 transition-colors"><Printer className="w-6 h-6" /><div className="text-left"><div className="font-bold">Cetak / Simpan PDF</div><div className="text-xs text-slate-300">Menggunakan pencetak sistem</div></div></button>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden print:shadow-none print:border-none">
        <div className="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between"><span>Pratonton Laporan: {selectedMonth}</span><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{monthlyLogs.length} Rekod</span></div>
        <table className="w-full text-sm text-left text-slate-600"><thead className="text-xs text-slate-500 uppercase bg-slate-50"><tr><th className="px-4 py-3">Tarikh</th><th className="px-4 py-3">Tempat</th><th className="px-4 py-3">Perkara</th><th className="px-4 py-3">Catatan</th></tr></thead><tbody>{monthlyLogs.map((log) => (<tr key={log.id} className="border-b"><td className="px-4 py-3">{formatDate(log.date)}</td><td className="px-4 py-3">{log.location}</td><td className="px-4 py-3">{log.type}</td><td className="px-4 py-3 italic">{log.catatan || '-'}</td></tr>))}{monthlyLogs.length === 0 && (<tr><td colSpan="4" className="px-4 py-8 text-center text-slate-400">Tiada rekod untuk bulan ini.</td></tr>)}</tbody></table>
      </div>
    </div>
  );
};

const StaffDashboard = ({ user, logs, onAddLog, combinedLocations, combinedActivityTypes }) => {
  const [activeTab, setActiveTab] = useState('daftar'); 
  return (
    <div className="p-6 lg:p-10 flex-1">
      <div className="mb-8"><h1 className="text-2xl font-bold text-slate-800">Selamat Datang, {user.name}</h1><p className="text-slate-500">{user.department}</p></div>
      <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6">
        <button onClick={() => setActiveTab('daftar')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'daftar' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Plus className="w-4 h-4"/> <span>Daftar Pergerakan</span></span></button>
        <button onClick={() => setActiveTab('saring')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'saring' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Filter className="w-4 h-4"/> <span>Saring Rekod</span></span></button>
        <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 ${activeTab === 'laporan' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><FileText className="w-4 h-4"/> <span>Laporan Bulanan</span></span></button>
      </div>
      <div className="min-h-[400px]">
        {activeTab === 'daftar' && (<StaffEntryTab onSubmit={onAddLog} availableLocations={combinedLocations} availableTypes={combinedActivityTypes} />)}
        {activeTab === 'saring' && <StaffFilterTab logs={logs} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />}
        {activeTab === 'laporan' && <StaffReportTab logs={logs} />}
      </div>
    </div>
  );
};

// ... Admin components (DataManagement, Analysis, Stats, Leaderboard, Report) ...
// Copying structure from previous turn but ensuring props are passed through

const AdminDataManagementTab = ({ locations, activityTypes, users, onAddLocation, onDeleteLocation, onAddActivity, onDeleteActivity, onDeleteUser }) => {
  const [newLocation, setNewLocation] = useState('');
  const [newActivity, setNewActivity] = useState('');
  const [itemToDelete, setItemToDelete] = useState(null); 
  const triggerDelete = (type, id, name) => setItemToDelete({ type, id, name });
  const confirmDelete = () => { if (!itemToDelete) return; const { type, id } = itemToDelete; if (type === 'location') onDeleteLocation(id); if (type === 'activity') onDeleteActivity(id); if (type === 'user') onDeleteUser(id); setItemToDelete(null); };
  const sortedUsers = [...users].sort((a, b) => a.name.localeCompare(b.name));
  const nameCounts = sortedUsers.reduce((acc, user) => { acc[user.name] = (acc[user.name] || 0) + 1; return acc; }, {});

  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><MapPin className="w-5 h-5 mr-2 text-blue-600" /> Senarai Lokasi (Master)</h3>
          <div className="flex gap-2 mb-4"><input type="text" value={newLocation} onChange={(e) => setNewLocation(e.target.value)} placeholder="Tambah lokasi..." className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" /><button onClick={() => { if(newLocation) { onAddLocation(newLocation); setNewLocation(''); }}} className="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700"><Plus className="w-5 h-5" /></button></div>
          <div className="max-h-60 overflow-y-auto space-y-2">{locations.map((loc) => (<div key={loc.id} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm"><span>{loc.name}</span><button onClick={() => triggerDelete('location', loc.id, loc.name)} className="text-slate-400 hover:text-red-500 p-1"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </div>
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
          <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><FileText className="w-5 h-5 mr-2 text-blue-600" /> Senarai Perkara (Master)</h3>
          <div className="flex gap-2 mb-4"><input type="text" value={newActivity} onChange={(e) => setNewActivity(e.target.value)} placeholder="Tambah perkara..." className="flex-1 border border-slate-300 rounded-lg p-2 text-sm" /><button onClick={() => { if(newActivity) { onAddActivity(newActivity); setNewActivity(''); }}} className="bg-blue-600 text-white px-3 rounded-lg hover:bg-blue-700"><Plus className="w-5 h-5" /></button></div>
          <div className="max-h-60 overflow-y-auto space-y-2">{activityTypes.map((type) => (<div key={type.id} className="flex justify-between items-center bg-slate-50 p-2 rounded text-sm"><span>{type.name}</span><button onClick={() => triggerDelete('activity', type.id, type.name)} className="text-slate-400 hover:text-red-500 p-1"><Trash2 className="w-4 h-4" /></button></div>))}</div>
        </div>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><div className="p-6 border-b border-slate-100"><h3 className="text-lg font-bold text-slate-800 flex items-center"><Users className="w-5 h-5 mr-2 text-blue-600" /> Senarai Pengguna</h3></div><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3">Nama Penuh</th><th className="px-6 py-3">ID</th><th className="px-6 py-3">Jabatan</th><th className="px-6 py-3 text-right">Tindakan</th></tr></thead><tbody>{sortedUsers.map(user => { const isDuplicate = nameCounts[user.name] > 1; return (<tr key={user.id} className={`border-b ${isDuplicate ? 'bg-pink-50' : 'hover:bg-slate-50'}`}><td className="px-6 py-4 font-medium text-slate-900 flex items-center">{user.name}{isDuplicate && <span className="ml-2 text-pink-600"><AlertTriangle className="w-4 h-4"/></span>}</td><td className="px-6 py-4">{user.username}</td><td className="px-6 py-4">{user.department}</td><td className="px-6 py-4 text-right">{user.role !== 'admin' && (<button onClick={() => triggerDelete('user', user.id, user.name)} className="text-red-500 hover:text-red-700 bg-red-50 p-2 rounded-lg"><Trash2 className="w-4 h-4" /></button>)}</td></tr>); })}</tbody></table></div></div>
      <DeleteConfirmationModal isOpen={!!itemToDelete} onClose={() => setItemToDelete(null)} onConfirm={confirmDelete} itemName={itemToDelete?.name} />
    </div>
  );
};

const AdminAnalysisTab = ({ logs, allUsers, combinedLocations, combinedActivityTypes }) => {
  const [filterMonth, setFilterMonth] = useState('');
  const [filterStaff, setFilterStaff] = useState('');
  const [filterPlace, setFilterPlace] = useState('');
  const [filterType, setFilterType] = useState('');
  const filteredLogs = logs.filter(log => { if (!log.date) return false; const matchMonth = filterMonth ? log.date.startsWith(filterMonth) : true; const matchStaff = filterStaff ? log.userName === filterStaff : true; const matchPlace = filterPlace ? log.location === filterPlace : true; const matchType = filterType ? log.type === filterType : true; return matchMonth && matchStaff && matchPlace && matchType; });

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring Rekod (Slicers)</h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label className="block text-xs font-semibold text-slate-500 mb-1">Bulan</label><input type="month" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white" /></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Staf</label><select value={filterStaff} onChange={(e) => setFilterStaff(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Staf</option>{allUsers.map((u, idx) => <option key={idx} value={u}>{u}</option>)}</select></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Lokasi</label><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Lokasi</option>{combinedLocations.map((loc, idx) => <option key={idx} value={loc}>{loc}</option>)}</select></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Perkara</label><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Perkara</option>{combinedActivityTypes.map((type, idx) => <option key={idx} value={type}>{type}</option>)}</select></div></div><div className="mt-4 flex justify-between items-center pt-2 border-t border-slate-50"><span className="text-sm text-slate-500">Jumlah Rekod: <strong>{filteredLogs.length}</strong></span><button onClick={() => { setFilterMonth(''); setFilterStaff(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-blue-600 hover:text-blue-800 font-medium">Kosongkan Semua</button></div></div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3">Tarikh</th><th className="px-6 py-3">Nama</th><th className="px-6 py-3">Lokasi</th><th className="px-6 py-3">Perkara</th></tr></thead><tbody>{filteredLogs.length > 0 ? filteredLogs.map(log => (<tr key={log.id} className="border-b hover:bg-slate-50"><td className="px-6 py-4">{formatDate(log.date)}</td><td className="px-6 py-4 font-bold text-slate-800">{log.userName}</td><td className="px-6 py-4">{log.location}</td><td className="px-6 py-4">{log.type}</td></tr>)) : (<tr><td colSpan="4" className="px-6 py-12 text-center text-slate-400">Tiada rekod ditemui dengan saringan ini.</td></tr>)}</tbody></table></div></div>
    </div>
  );
};

const AdminStatsTab = ({ logs, allUsers, combinedLocations, combinedActivityTypes }) => {
  const [filterMonth, setFilterMonth] = useState(''); const [filterStaff, setFilterStaff] = useState(''); const [filterPlace, setFilterPlace] = useState(''); const [filterType, setFilterType] = useState('');
  const filteredLogs = logs.filter(log => { if (!log.date) return false; const matchMonth = filterMonth ? log.date.startsWith(filterMonth) : true; const matchStaff = filterStaff ? log.userName === filterStaff : true; const matchPlace = filterPlace ? log.location === filterPlace : true; const matchType = filterType ? log.type === filterType : true; return matchMonth && matchStaff && matchPlace && matchType; });
  const getChartData = (key) => { const counts = filteredLogs.reduce((acc, log) => { const val = log[key] || 'Lain-lain'; acc[val] = (acc[val] || 0) + 1; return acc; }, {}); const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1']; return Object.keys(counts).map((label, i) => ({ label, value: counts[label], color: colors[i % colors.length] })).sort((a,b) => b.value - a.value); };

  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Filter className="w-5 h-5 mr-2 text-blue-600" /> Saringan Data Statistik</h3><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><div><label className="block text-xs font-semibold text-slate-500 mb-1">Bulan</label><input type="month" value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white" /></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Staf</label><select value={filterStaff} onChange={(e) => setFilterStaff(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Staf</option>{allUsers.map((u, idx) => <option key={idx} value={u}>{u}</option>)}</select></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Lokasi</label><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Lokasi</option>{combinedLocations.map((loc, idx) => <option key={idx} value={loc}>{loc}</option>)}</select></div><div><label className="block text-xs font-semibold text-slate-500 mb-1">Perkara</label><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Perkara</option>{combinedActivityTypes.map((type, idx) => <option key={idx} value={type}>{type}</option>)}</select></div></div><div className="mt-4 flex justify-end"><button onClick={() => { setFilterMonth(''); setFilterStaff(''); setFilterPlace(''); setFilterType(''); }} className="text-sm text-blue-600 hover:text-blue-800 font-medium">Reset Saringan</button></div></div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col"><h4 className="font-bold text-slate-800 text-center mb-6 border-b pb-2">Peratus Mengikut Perkara</h4><div className="flex-1 flex items-center justify-center"><ConicPieChart data={getChartData('type')} /></div></div>
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col"><h4 className="font-bold text-slate-800 text-center mb-6 border-b pb-2">Peratus Mengikut Tempat</h4><div className="flex-1 flex items-center justify-center"><ConicPieChart data={getChartData('location')} /></div></div>
        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col"><h4 className="font-bold text-slate-800 text-center mb-6 border-b pb-2">Peratus Mengikut Staf</h4><div className="flex-1 flex items-center justify-center"><ConicPieChart data={getChartData('userName')} totalLabel="Staf Aktif" /></div></div>
      </div>
    </div>
  );
};

const AdminLeaderboardTab = ({ logs }) => {
  const totalEntries = logs.reduce((acc, log) => { acc[log.userName] = (acc[log.userName] || 0) + 1; return acc; }, {});
  const sortedTotal = Object.entries(totalEntries).sort((a, b) => b[1] - a[1]).map(([name, count], i) => ({ rank: i + 1, name, count }));
  const coachingLogs = logs.filter(log => { const text = (log.type + ' ' + log.catatan).toLowerCase(); return text.includes('bimbingan') || text.includes('coaching') || text.includes('mentoring'); });
  const coachingEntries = coachingLogs.reduce((acc, log) => { acc[log.userName] = (acc[log.userName] || 0) + 1; return acc; }, {});
  const sortedCoaching = Object.entries(coachingEntries).sort((a, b) => b[1] - a[1]).map(([name, count], i) => ({ rank: i + 1, name, count }));
  const RankTable = ({ title, data, icon: Icon, color }) => ( <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden h-full"><div className={`p-4 ${color} text-white font-bold flex items-center`}><Icon className="w-5 h-5 mr-2" /> {title}</div><table className="w-full text-sm text-left text-slate-600"><thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-6 py-3 w-16">#</th><th className="px-6 py-3">Nama Pegawai</th><th className="px-6 py-3 text-right">Jumlah</th></tr></thead><tbody>{data.length > 0 ? data.map((item) => (<tr key={item.name} className="border-b hover:bg-slate-50 last:border-0"><td className="px-6 py-4 font-bold text-slate-400">{item.rank === 1 ? 'ü•á' : item.rank === 2 ? 'ü•à' : item.rank === 3 ? 'ü•â' : item.rank}</td><td className="px-6 py-4 font-medium text-slate-900">{item.name}</td><td className="px-6 py-4 text-right font-bold text-blue-900">{item.count}</td></tr>)) : (<tr><td colSpan="3" className="px-6 py-8 text-center text-slate-400">Tiada data direkodkan.</td></tr>)}</tbody></table></div>);
  return ( <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-4 duration-500"><RankTable title="Ranking Pengisian Terbanyak" data={sortedTotal} icon={Trophy} color="bg-blue-600" /><RankTable title="Ranking Coaching & Mentoring" data={sortedCoaching} icon={TrendingUp} color="bg-green-600" /></div> );
};

const AdminReportTab = ({ logs, allUsers, combinedLocations, combinedActivityTypes }) => {
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
  const [filterStaff, setFilterStaff] = useState(''); const [filterPlace, setFilterPlace] = useState(''); const [filterType, setFilterType] = useState('');
  const filteredLogs = logs.filter(log => { if (!log.date) return false; const matchMonth = selectedMonth ? log.date.startsWith(selectedMonth) : true; const matchStaff = filterStaff ? log.userName === filterStaff : true; const matchPlace = filterPlace ? log.location === filterPlace : true; const matchType = filterType ? log.type === filterType : true; return matchMonth && matchStaff && matchPlace && matchType; });

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
        <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Filter className="w-5 h-5 mr-2 text-blue-600" /> Saring & Muat Turun Laporan</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div><label className="block text-xs font-semibold text-slate-500 mb-1">Bulan</label><input type="month" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white" /></div>
          <div><label className="block text-xs font-semibold text-slate-500 mb-1">Staf</label><select value={filterStaff} onChange={(e) => setFilterStaff(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Staf</option>{allUsers.map((u, idx) => <option key={idx} value={u}>{u}</option>)}</select></div>
          <div><label className="block text-xs font-semibold text-slate-500 mb-1">Lokasi</label><select value={filterPlace} onChange={(e) => setFilterPlace(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Lokasi</option>{combinedLocations.map((loc, idx) => <option key={idx} value={loc}>{loc}</option>)}</select></div>
          <div><label className="block text-xs font-semibold text-slate-500 mb-1">Perkara</label><select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white"><option value="">Semua Perkara</option>{combinedActivityTypes.map((type, idx) => <option key={idx} value={type}>{type}</option>)}</select></div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-slate-100 pt-4">
            <button onClick={() => downloadCSV(filteredLogs, `Laporan_Admin_${selectedMonth}.csv`)} className="flex items-center justify-center space-x-2 bg-green-600 text-white p-3 rounded-lg shadow-sm hover:bg-green-700 transition-colors"><FileSpreadsheet className="w-5 h-5" /><div className="text-left"><div className="font-bold text-sm">Muat Turun Excel (CSV)</div></div></button>
            <button onClick={() => window.print()} className="flex items-center justify-center space-x-2 bg-slate-700 text-white p-3 rounded-lg shadow-sm hover:bg-slate-800 transition-colors"><Printer className="w-5 h-5" /><div className="text-left"><div className="font-bold text-sm">Cetak / Simpan PDF</div></div></button>
        </div>
      </div>
      <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden print:shadow-none print:border-none">
        <div className="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-slate-700 flex justify-between items-center"><span>Pratonton Laporan: {selectedMonth}</span><span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">{filteredLogs.length} Rekod Dijumpai</span></div>
        <div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-600"><thead className="bg-slate-50 text-xs uppercase text-slate-500"><tr><th className="px-4 py-3">Tarikh</th><th className="px-4 py-3">Nama Pegawai</th><th className="px-4 py-3">Tempat</th><th className="px-4 py-3">Perkara</th><th className="px-4 py-3">Catatan</th></tr></thead><tbody>{filteredLogs.length > 0 ? filteredLogs.map((log) => (<tr key={log.id} className="border-b hover:bg-slate-50"><td className="px-4 py-3">{formatDate(log.date)}</td><td className="px-4 py-3 font-medium">{log.userName}</td><td className="px-4 py-3">{log.location}</td><td className="px-4 py-3">{log.type}</td><td className="px-4 py-3 italic">{log.catatan || '-'}</td></tr>)) : (<tr><td colSpan="5" className="px-4 py-8 text-center text-slate-400">Tiada rekod untuk padanan ini.</td></tr>)}</tbody></table></div>
      </div>
    </div>
  );
};

const AdminDashboard = ({ user, logs, data, onAddLocation, onDeleteLocation, onAddActivity, onDeleteActivity, onDeleteUser, allUsers, combinedLocations, combinedActivityTypes }) => {
  const [activeTab, setActiveTab] = useState('data');
  return (
    <div className="p-6 lg:p-10 flex-1">
      <h1 className="text-2xl font-bold text-slate-800 mb-2">Paparan Utama Admin</h1>
      <p className="text-slate-500 mb-6">Urus sistem E-Gerak PPD Ranau.</p>
      <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 border-b border-slate-200 mb-6 overflow-x-auto">
        <button onClick={() => setActiveTab('data')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'data' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Settings className="w-4 h-4"/> <span>1. Pengurusan Data</span></span></button>
        <button onClick={() => setActiveTab('analisis')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'analisis' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Filter className="w-4 h-4"/> <span>2. Analisis & Rekod</span></span></button>
        <button onClick={() => setActiveTab('stats')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'stats' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><PieChart className="w-4 h-4"/> <span>3. Statistik</span></span></button>
        <button onClick={() => setActiveTab('leaderboard')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'leaderboard' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><Trophy className="w-4 h-4"/> <span>4. Leaderboard</span></span></button>
        <button onClick={() => setActiveTab('laporan')} className={`pb-3 px-4 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === 'laporan' ? 'border-blue-900 text-blue-900' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><span className="flex items-center space-x-2"><FileText className="w-4 h-4"/> <span>5. Laporan Bulanan</span></span></button>
      </div>
      <div className="min-h-[500px]">
        {activeTab === 'data' && (<AdminDataManagementTab locations={data.locations} activityTypes={data.activityTypes} users={data.users} onAddLocation={onAddLocation} onDeleteLocation={onDeleteLocation} onAddActivity={onAddActivity} onDeleteActivity={onDeleteActivity} onDeleteUser={onDeleteUser} />)}
        {activeTab === 'analisis' && (<AdminAnalysisTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
        {activeTab === 'stats' && (<AdminStatsTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
        {activeTab === 'leaderboard' && <AdminLeaderboardTab logs={logs} />}
        {activeTab === 'laporan' && (<AdminReportTab logs={logs} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />)}
      </div>
    </div>
  );
};

// --- APP COMPONENT (Data Fetching & Auth) ---
export default function App() {
  const [user, setUser] = useState(null);
  const [error, setError] = useState('');
  const [successMsg, setSuccessMsg] = useState('');
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [showSuccessModal, setShowSuccessModal] = useState(false);
  const [usersLoading, setUsersLoading] = useState(true);

  // Data States
  const [usersList, setUsersList] = useState([]);
  const [logsList, setLogsList] = useState([]);
  const [locationsList, setLocationsList] = useState([]);
  const [activitiesList, setActivitiesList] = useState([]);

  // --- FIREBASE AUTH & DATA LISTENERS ---
  useEffect(() => {
    // 1. Auth Init
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();

    const unsubscribeAuth = onAuthStateChanged(auth, (currentUser) => {
      if (currentUser) {
        // Only start listening to data once authenticated
        
        // Listen to Users
        const unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snapshot) => {
          const loadedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setUsersList(loadedUsers);
          setUsersLoading(false);
        });

        // Listen to Logs
        const logsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('date', 'desc'));
        const unsubLogs = onSnapshot(logsQuery, (snapshot) => {
          setLogsList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        // Listen to Locations
        const unsubLocs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'locations'), (snapshot) => {
          setLocationsList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        // Listen to Activities
        const unsubActs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), (snapshot) => {
          setActivitiesList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });

        return () => { unsubUsers(); unsubLogs(); unsubLocs(); unsubActs(); };
      }
    });

    return () => unsubscribeAuth();
  }, []);

  // --- HANDLERS ---
  
  const handleLogin = (username, password, role) => {
    // Check against real data from Firestore
    const foundUser = usersList.find(u => u.username === username && u.password === password && u.role === role);
    if (foundUser) { setUser(foundUser); setError(''); setSuccessMsg(''); } 
    else { setError('ID Pengguna atau Kata Laluan tidak sah.'); setSuccessMsg(''); }
  };

  const handleRegister = async (newUser) => {
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users'), newUser);
      setSuccessMsg('Pendaftaran berjaya! Sila log masuk.'); setError('');
    } catch (e) { setError('Gagal mendaftar. Sila cuba lagi.'); }
  };

  const handleLogout = () => { setUser(null); setIsMobileMenuOpen(false); setSuccessMsg(''); setError(''); };

  const handleAddLog = async (newLogData) => {
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
        ...newLogData,
        userId: user.id,
        userName: user.name,
        createdAt: serverTimestamp()
      });
      setShowSuccessModal(true);
    } catch (e) { alert("Gagal menyimpan rekod. Sila semak sambungan internet."); }
  };

  // Admin Actions
  const handleAddLocation = async (name) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'locations'), { name }); };
  const handleDeleteLocation = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'locations', id)); };
  const handleAddActivity = async (name) => { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), { name }); };
  const handleDeleteActivity = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', id)); };
  const handleDeleteUser = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id)); };

  // --- COMPUTED DATA FOR PROPS ---
  const combinedLocations = useMemo(() => {
    const logLocs = logsList.map(l => l.location).filter(Boolean);
    const masterLocs = locationsList.map(l => l.name);
    return Array.from(new Set([...masterLocs, ...logLocs])).sort();
  }, [logsList, locationsList]);

  const combinedActivityTypes = useMemo(() => {
    const logTypes = logsList.map(l => l.type).filter(Boolean);
    const masterTypes = activitiesList.map(l => l.name);
    return Array.from(new Set([...masterTypes, ...logTypes])).sort();
  }, [logsList, activitiesList]);

  const allUsers = useMemo(() => {
    const logUserNames = logsList.map(l => l.userName);
    const registeredUserNames = usersList.map(u => u.name);
    return Array.from(new Set([...registeredUserNames, ...logUserNames])).sort();
  }, [logsList, usersList]);

  // Pass data object to Admin Dashboard
  const adminData = { users: usersList, locations: locationsList, activityTypes: activitiesList };
  
  // Filter logs for logged-in user if not admin
  const relevantLogs = user ? (user.role === 'admin' ? logsList : logsList.filter(log => log.userId === user.id)) : [];

  if (!user) return <LoginPage onLogin={handleLogin} onRegister={handleRegister} error={error} setError={setError} usersLoading={usersLoading} />;

  return (
    <div className="min-h-screen bg-slate-50 flex font-sans">
      <aside className="hidden md:flex flex-col w-64 bg-blue-900 text-white fixed h-full z-10 print:hidden"><div className="p-6 flex items-center space-x-3 border-b border-blue-800"><div className="bg-white p-1 rounded-full"><MapPin className="w-6 h-6 text-blue-900" /></div><span className="font-bold text-lg tracking-wide">E-Gerak</span></div><div className="flex-1 p-4"><div className="p-4 bg-blue-800 rounded-xl mb-4"><p className="text-xs text-blue-300 uppercase tracking-wider mb-1">Akaun</p><p className="font-bold truncate">{user.name}</p><p className="text-xs text-blue-200">{user.role === 'admin' ? 'Pentadbir Sistem' : 'Pegawai / Staf'}</p></div></div><div className="p-4 border-t border-blue-800"><button onClick={handleLogout} className="flex items-center space-x-2 text-sm text-blue-200 hover:text-white w-full px-2 py-2 rounded-lg hover:bg-blue-800 transition-colors"><LogOut className="w-4 h-4" /><span>Log Keluar</span></button></div></aside>
      <main className="flex-1 md:ml-64 flex flex-col min-h-screen">
        <header className="bg-white shadow-sm sticky top-0 z-20 md:hidden px-4 py-3 flex justify-between items-center print:hidden"><div className="flex items-center space-x-2"><MapPin className="text-blue-900 w-6 h-6" /><span className="font-bold text-blue-900">E-Gerak</span></div><button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}>{isMobileMenuOpen ? <X className="text-slate-600" /> : <Menu className="text-slate-600" />}</button></header>
        {isMobileMenuOpen && (<div className="md:hidden bg-blue-900 text-white p-4 space-y-3 absolute top-14 w-full z-20 shadow-xl print:hidden"><div className="pb-3 border-b border-blue-700 mb-3"><p className="font-bold">{user.name}</p><p className="text-xs text-blue-300">{user.department}</p></div><button onClick={handleLogout} className="block w-full text-left py-2 text-red-300">Log Keluar</button></div>)}
        {user.role === 'staff' ? (
          <StaffDashboard user={user} logs={relevantLogs} onAddLog={handleAddLog} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />
        ) : (
          <AdminDashboard user={user} logs={relevantLogs} data={adminData} onAddLocation={handleAddLocation} onDeleteLocation={handleDeleteLocation} onAddActivity={handleAddActivity} onDeleteActivity={handleDeleteActivity} onDeleteUser={handleDeleteUser} allUsers={allUsers} combinedLocations={combinedLocations} combinedActivityTypes={combinedActivityTypes} />
        )}
      </main>
      <SuccessModal isOpen={showSuccessModal} onClose={() => setShowSuccessModal(false)} message="Laporan telah dihantar." />
    </div>
  );
}